function StickyStore(e){var t=this,r={name:"Sticky",adapters:["localStorage","indexedDB","webSQL","cookie"],expires:864e5,size:5};if(e)for(var o in r)e[o]||(e[o]=r[o]);else e=r;if(t.options=e,e.ready){if("function"!=typeof e.ready)throw new Error("options.ready callback must be a function");t.on("ready",e.ready)}if(e.name){var i=new RegExp("/W/","i");if(i.test(e.name))throw new Error("options.name can only contain A-z, 0-9, and underscores.")}var a=function(e,t){for(var r,o=0;o<this.options.adapters.length;o++)this.options.adapters[o]===e&&(r=o+1);t&&(this.adapters[e].index=this.connected.push(e)-1,1===this.connected.length&&this.trigger("ready",this)),r&&this.adapters[this.options.adapters[r]]&&this.adapters[this.options.adapters[r]].init.call(this,a)};t.connected=[],t.adapters[e.adapters[0]].init.call(t,a)}StickyStore.prototype.on=function(e,t){this.events=this.events||{},this.events[e]?this.events[e].push(t):this.events[e]=[t]},StickyStore.prototype.trigger=function(e,t){if(t=Array.prototype.slice.call(arguments,1),this.events&&this.events[e])for(var r=0;r<this.events[e].length;r++)this.events[e][r].apply(this,t)},StickyStore.prototype.exec=function(e,t,r,o,i){var a,n,s=this;"string"==typeof o&&(i=o,o=null),"undefined"==typeof i&&(i=s.connected[0]),"number"==typeof s.adapters[i].index&&(a=s.connected[s.adapters[i].index+1]);var c="indexedDB"===i||"webSQL"===i?!0:!1,l="set"===e?[t,r]:[t];c===!0&&(n=function(r){return r===!1&&"string"==typeof a?(l.splice(-1,1),l.push(o,a),s[e].apply(s,l)):(o&&o.call(s,r),void s.trigger(e,t,r))},l.push(n));var p;if("undefined"!=typeof s.adapters[i].io){if(c)return s.adapters[i][e].apply(s,l);p=s.adapters[i][e].apply(s,l)}return p===!1&&"string"==typeof a?(l.push(o,a),s[e].apply(s,l)):(s.trigger(e,t,p),o&&o.call(s,p),p)},StickyStore.prototype.get=function(e,t,r){if(e.constructor===Array){var o,i=e;if(t){var a=this,n=[];o=function(e){n.push(e),n.length===i.length&&(t.call(a,n),a.trigger("get",i))}}for(var s=[],c=0;c<i.length;c++)s.push(this.exec.call(this,"get",i[c],null,o,r));return s}return this.exec.call(this,"get",e,null,t,r)},StickyStore.prototype.set=function(e,t,r,o){if(void 0===t||null===t)return!1;if(e.constructor===Array&&t.constructor===Array){var i,a=e,n=t;if(r){var s=this,c=[];i=function(e){c.push(e),c.length===a.length&&(r.call(s,c),s.trigger("set",a,l))}}for(var l=[],p=0;p<a.length;p++)l.push(this.exec.call(this,"set",a[p],n[p],i,o));return l}return this.exec.call(this,"set",e,t,r,o)},StickyStore.prototype.remove=function(e,t,r){var o;"string"==typeof t&&(r=t,t=null);var i=r?[r]:this.connected;if(t){var a=this,n=0;o=function(r){n++,n===i.length&&(t.call(a,!0),a.trigger("remove",e))}}if(i.length>1){for(var s=0;s<i.length;s++)i[s]===r?o.call(this,!0):this.adapters[i[s]].remove.call(this,e,o);return this.exec.call(this,"remove",e,null,null,r)}return this.exec.call(this,"remove",e,null,t,r)},StickyStore.prototype.removeAll=function(e,t){var r;"string"==typeof e&&(t=e,e=null);var o=t?[t]:this.connected;if(e){var i=this,a=0;r=function(t){a++,a===o.length&&(e.call(i,!0),i.trigger("removeAll"))}}for(var n=0;n<o.length;n++)this.adapters[o[n]].removeAll.call(this,r)},StickyStore.prototype.adapters={indexedDB:{},webSQL:{},localStorage:{},cookie:{}},StickyStore.prototype.adapters.indexedDB.init=function(e){var t=this;window&&(StickyStore.prototype.IndexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB);var r=function(e){!t.adapters.indexedDB.io&&e.target.result&&(t.adapters.indexedDB.io=e.target.result.db?e.target.result.db:e.target.result),t.adapters.indexedDB.io.objectStoreNames.contains(t.options.name)||t.adapters.indexedDB.io.createObjectStore(t.options.name,{keyPath:"key"})};if(StickyStore.prototype.IndexedDB){var o=StickyStore.prototype.IndexedDB.open(t.options.name,20);o.onsuccess=function(o){if(!t.adapters.indexedDB.io&&o.target.result&&(t.adapters.indexedDB.io=o.target.result.db?o.target.result.db:o.target.result),o.target.result.setVersion&&"2.0"!==o.target.result.version){var i=t.adapters.indexedDB.io.setVersion("2.0");i.onsuccess=r,i.onerror=function(r){e&&e.call(t,"indexedDB",!1),t.trigger("error","Couldn't change indexedDB version (Code "+i.errorCode+")")}}else e&&e.call(t,"indexedDB",!0)},o.onupgradeneeded=r,o.onerror=function(r){e&&e.call(t,"indexedDB",!1),t.trigger("error","Couldn't open indexedDB (Code "+o.errorCode+")")}}else e&&e.call(t,"indexedDB",!1)},StickyStore.prototype.adapters.indexedDB.get=function(e,t){var r=this,o=r.adapters.indexedDB.io.transaction([r.options.name],"readonly"),i=o.objectStore(r.options.name),a=i.get(e);a.onsuccess=function(e){e.target.result?t&&t.call(r,e.target.result.data):t&&t.call(r,!1)},a.onerror=function(e){r.trigger("error","Couldn't get item from indexedDB objectStore (Code "+a.errorCode+")"),t&&t.call(r,!1)}},StickyStore.prototype.adapters.indexedDB.set=function(e,t,r){var o=this,i=o.adapters.indexedDB.io.transaction([o.options.name],"readwrite"),a=i.objectStore(o.options.name),n=a.put({key:e,data:t});return n.onsuccess=function(e){r&&r.call(o,t)},n.onerror=function(e){o.trigger("error","Failed to store item in indexedDB (Code: "+e.target.errorCode+")",t),r&&r.call(o,!1)},t},StickyStore.prototype.adapters.indexedDB.remove=function(e,t){var r=this,o=r.adapters.indexedDB.io.transaction([r.options.name],"readwrite"),i=o.objectStore(r.options.name)["delete"](e);i.onsuccess=function(e){t&&t.call(r,!0)},i.onerror=function(o){r.trigger("error","Error removing item from indexedDB",e),t&&t.call(r,!1)}},StickyStore.prototype.adapters.indexedDB.removeAll=function(e){var t=this,r=t.adapters.indexedDB.io.transaction([t.options.name],"readwrite"),o=r.objectStore(t.options.name).clear();o.onsuccess=function(r){e&&e.call(t,!0)},o.onerror=function(r){t.trigger("error","Error deleting indexedDB database",err),e&&e.call(t,!1)}},StickyStore.prototype.adapters.webSQL.init=function(e){var t=this;try{t.adapters.webSQL.io=window.openDatabase("Sticky","2.0","Sticky Offline Web Cache",1024*t.options.size*1024),t.adapters.webSQL.io&&t.adapters.webSQL.io.transaction(function(r){r.executeSql("CREATE TABLE IF NOT EXISTS "+t.options.name+" (key TEXT, data TEXT)"),e&&e.call(t,"webSQL",!0)})}catch(r){e&&e.call(t,"webSQL",!1),t.trigger("error",r)}},StickyStore.prototype.adapters.webSQL.get=function(e,t){var r,o=this;o.adapters.webSQL.io.transaction(function(i){i.executeSql("SELECT * FROM "+o.options.name+" WHERE key=?",[e],function(e,i){if(1===i.rows.length){var a=i.rows.item(0);r=o.unserialize(a.data),t&&t.call(o,r)}else t&&t.call(o,!1)},function(r,i){o.trigger("error","Couldn't get webSQL item with key: "+e,e),t&&t.call(o,!1)})})},StickyStore.prototype.adapters.webSQL.set=function(e,t,r){var o=this,i=this.serialize(t),a=function(a,n){0===n.rowsAffected?a.executeSql("INSERT INTO "+o.options.name+" (key, data) VALUES (?, ?)",[e,i],function(e,i){0===i.rowsAffected?(o.trigger("error","Failed to insert webSQL item",t),r&&r.call(o,!1)):r&&r.call(o,t)}):r&&r.call(o,t)},n=function(t){t.executeSql("UPDATE "+o.options.name+" SET data=? WHERE key=?",[i,e],a)};return o.adapters.webSQL.io.transaction(n),t},StickyStore.prototype.adapters.webSQL.remove=function(e,t){var r=this;r.adapters.webSQL.io.transaction(function(o){o.executeSql("DELETE FROM "+r.options.name+" WHERE key=?",[e],function(e,o){0===o.rowsAffected?t&&t.call(r,!1):t&&t.call(r,!0)},function(o,i){t&&t.call(r,!1),r.trigger("error","Failed to delete webSQL item",e)})})},StickyStore.prototype.adapters.webSQL.removeAll=function(e){var t=this;t.adapters.webSQL.io.transaction(function(r){r.executeSql("DELETE FROM "+t.options.name,[],function(r,o){0===o.rowsAffected?e&&e.call(t,!1):e&&e.call(t,!0)},function(r,o){e&&e.call(t,!1),t.trigger("error","Failed to remove all webSQL items",o.message)})})},StickyStore.prototype.adapters.localStorage.init=function(e){window.localStorage?(this.adapters.localStorage.io=localStorage,e&&e.call(this,"localStorage",!0)):window.globalStorage?(this.adapters.localStorage.io=globalStorage[this.options.domain],e&&e.call(this,"localStorage",!0)):e&&e.call(this,"localStorage",!1)},StickyStore.prototype.adapters.localStorage.get=function(e,t){var r;try{r=this.unserialize(this.adapters.localStorage.io.getItem(this.options.name+"_"+e))}catch(o){this.trigger("error",o)}return r?(t&&t.call(this,r),r):(t&&t.call(this,!1),!1)},StickyStore.prototype.adapters.localStorage.set=function(e,t,r){var o=this.serialize(t);try{return this.adapters.localStorage.io.setItem(this.options.name+"_"+e,o),r&&r.call(this,t),t}catch(i){return this.trigger("error",i,t),r&&r.call(this,!1),!1}},StickyStore.prototype.adapters.localStorage.remove=function(e,t){try{return this.adapters.localStorage.io.removeItem(this.options.name+"_"+e),t&&t.call(this,!0),!0}catch(r){return this.trigger("error",r,e),t&&t.call(this,!1),!1}},StickyStore.prototype.adapters.localStorage.removeAll=function(e){for(var t=[],r=0;r<this.adapters.localStorage.io.length;r++){var o=this.adapters.localStorage.io.key(r);0===o.indexOf(this.options.name)&&t.push(o)}for(var r=0;r<t.length;r++)this.adapters.localStorage.io.removeItem(t[r]);return e&&e.call(this,!0),!0},StickyStore.prototype.adapters.cookie.init=function(e){"string"==typeof document.cookie?(this.adapters.cookie.io=document.cookie,e&&e.call(this,"cookie",!0)):e&&e.call(this,"cookie",!1)},StickyStore.prototype.adapters.cookie.get=function(e,t){var r;if(e=this.options.name+"_"+e,-1===e.search(/\W/i)){var o=document.cookie.match(new RegExp(e+"=[a-zA-Z0-9.()=|%/]+($|;)","g"));o&&o[0]&&(r=unescape(o[0].substring(e.length+1,o[0].length).replace(";",""))||null)}else this.trigger("error","Key cannot contain special characters when persisting to cookies. Only A-z, 0-9, and _ are allowed.",e);return r?(r=this.unserialize(decodeURIComponent(r)),t&&t.call(this,r),r):(t&&t.call(this,!1),!1)},StickyStore.prototype.adapters.cookie.set=function(e,t,r){var o=encodeURIComponent(this.serialize(t));if(o.length+e.length-100>4e3)this.trigger("error","Serialized value too large for cookie storage",e);else if(-1!==e.search(/\W/i))this.trigger("error","Key cannot contain special characters when persisting to cookies. Only A-z, 0-9, and _ are allowed.",e);else{if(-1===o.search(/[;,=[ ]/i)){e=this.options.name+"_"+e;var i=new Date;i.setTime(i.getTime()+this.options.expires);var a=[e+"="+o,"path=/","expires="+i.toGMTString()];return document.cookie=a.join("; "),r&&r.call(this,t),t}this.trigger("error","Value cannot contain spaces, semi-colons, equals, or commas when persisting to cookies.",e)}return r&&r.call(this,!1),!1},StickyStore.prototype.adapters.cookie.remove=function(e,t){var r=this.adapters.cookie.get.call(this,e);if(r){e=this.options.name+"_"+e;var o=[e+"=","path=/","expires=Thu, 01-Jan-70 00:00:01 GMT"];return document.cookie=o.join("; "),t&&t.call(this,!0),!0}return t&&t.call(this,!1),!1},StickyStore.prototype.adapters.cookie.removeAll=function(e){for(var t=document.cookie.split(";"),r=0;r<t.length;r++){var o=t[r].split("=")[0];0===o.indexOf(this.options.name)&&this.adapters.cookie.remove.call(this,o.replace(this.options.name+"_",""))}return e&&e.call(this,!0),!0},StickyStore.prototype.serialize=function(e){var t;if("string"==typeof e&&e.length>0)t=e;else if("object"==typeof e||e.constructor===Array)try{t="J::O"+JSON.stringify(e)}catch(r){store.trigger("error",r,e)}else t=e.toString();return t},StickyStore.prototype.unserialize=function(e){var t;if(e)if("J::O"===e.substr(0,4))try{t=JSON.parse(e.substr(4))}catch(r){this.trigger("error",r,e)}else t=isNaN(e)===!1?Number(e):e;return t};
